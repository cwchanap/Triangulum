name: Unit Tests

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  unit-tests:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Run Unit Tests
        run: |
          set -o pipefail
          SIMULATORS_JSON="${RUNNER_TEMP}/simulators.json"
          xcrun simctl list devices available -j > "$SIMULATORS_JSON"
          SIMULATOR_UDID=$(python3 -c "import json,sys; data=json.load(sys.stdin); devices=[d for runtime in data.get('devices',{}).values() for d in runtime if d.get('isAvailable')]; iphones=[d for d in devices if 'iPhone' in d.get('name','')]; pick=(iphones or devices); print(pick[0]['udid'] if pick else '')" < "$SIMULATORS_JSON")
          if [ -z "$SIMULATOR_UDID" ]; then
            echo "No available iOS simulators detected."
            xcrun simctl list devices available
            exit 1
          fi
          DESTINATION="platform=iOS Simulator,id=$SIMULATOR_UDID"
          RESULT_BUNDLE="${RUNNER_TEMP}/triangulum-tests.xcresult"
          xcodebuild test -project Triangulum.xcodeproj -scheme Triangulum -destination "$DESTINATION" -only-testing:TriangulumTests -resultBundlePath "$RESULT_BUNDLE" | xcpretty
          RESULT=${PIPESTATUS[0]}
          if [ $RESULT -ne 0 ]; then
            echo "xcodebuild failed. Extracting test failures from xcresult..."
            export XCRESULT_JSON="${RUNNER_TEMP}/triangulum-tests.json"
            xcrun xcresulttool get object --legacy --path "$RESULT_BUNDLE" --format json > "$XCRESULT_JSON"
            python3 -c $'import json,os,sys\npath=os.environ.get("XCRESULT_JSON")\nif not path:\n    sys.exit(0)\nwith open(path,"r",encoding="utf-8") as handle:\n    data=json.load(handle)\nactions=data.get("actions",{}).get("_values") or []\nfailures=[]\nfor action in actions:\n    issues=action.get("actionResult",{}).get("issues",{})\n    summaries=issues.get("testFailureSummaries",{}).get("_values") or []\n    for summary in summaries:\n        name=summary.get("testCaseName",{}).get("_value")\n        message=summary.get("message",{}).get("_value")\n        location=summary.get("documentLocationInCreatingWorkspace",{}).get("url",{}).get("_value")\n        failures.append((name,message,location))\nif not failures:\n    print("No test failures found in xcresult.")\nelse:\n    print("Test failures:")\n    for name,message,location in failures:\n        if name or message:\n            print(f"- {name}: {message}")\n        if location:\n            print(f"  {location}")'
          fi
          exit $RESULT
