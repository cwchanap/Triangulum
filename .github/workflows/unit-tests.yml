name: Unit Tests

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  unit-tests:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Run Unit Tests
        run: |
          set -o pipefail
          SIMULATORS_JSON="${RUNNER_TEMP}/simulators.json"
          xcrun simctl list devices available -j > "$SIMULATORS_JSON"
          SIMULATOR_UDID=$(python3 -c "import json,sys; data=json.load(sys.stdin); devices=[d for runtime in data.get('devices',{}).values() for d in runtime if d.get('isAvailable')]; iphones=[d for d in devices if 'iPhone' in d.get('name','')]; pick=(iphones or devices); print(pick[0]['udid'] if pick else '')" < "$SIMULATORS_JSON")
          if [ -z "$SIMULATOR_UDID" ]; then
            echo "No available iOS simulators detected."
            xcrun simctl list devices available
            exit 1
          fi
          DESTINATION="platform=iOS Simulator,id=$SIMULATOR_UDID"
          RESULT_BUNDLE="${RUNNER_TEMP}/triangulum-tests.xcresult"
          if command -v xcpretty >/dev/null 2>&1; then
            xcodebuild test -project Triangulum.xcodeproj -scheme Triangulum -destination "$DESTINATION" -only-testing:TriangulumTests -resultBundlePath "$RESULT_BUNDLE" | xcpretty
            RESULT=${PIPESTATUS[0]}
          else
            echo "xcpretty not found; using raw xcodebuild output"
            xcodebuild test -project Triangulum.xcodeproj -scheme Triangulum -destination "$DESTINATION" -only-testing:TriangulumTests -resultBundlePath "$RESULT_BUNDLE"
            RESULT=$?
          fi
          if [ $RESULT -ne 0 ]; then
            echo "xcodebuild failed. Extracting test failures from xcresult..."
            export XCRESULT_JSON="${RUNNER_TEMP}/triangulum-tests.json"
            SUMMARY_JSON="${RUNNER_TEMP}/triangulum-tests-summary.json"
            if ! xcrun xcresulttool get test-results summary --path "$RESULT_BUNDLE" --compact > "$SUMMARY_JSON"; then
              echo "xcresulttool test-results summary failed."
              xcrun xcresulttool get test-results summary --path "$RESULT_BUNDLE" || true
            else
              python3 -c $'import json,sys\npath=sys.argv[1]\ntry:\n    with open(path,"r",encoding="utf-8") as handle:\n        data=json.load(handle)\nexcept Exception as exc:\n    print(f"Failed to parse summary JSON: {exc}")\n    sys.exit(0)\n\nfailures=data.get("testFailures") or []\nfailed=data.get("failedTests",0)\ntotal=data.get("totalTestCount",0)\nprint(f"Summary: {failed} failed / {total} total")\nif failures:\n    print("Failing tests (summary):")\n    for failure in failures:\n        name=failure.get("testName","")\n        target=failure.get("targetName","")\n        text=failure.get("failureText","")\n        if target:\n            print(f"- {name} ({target}): {text}")\n        else:\n            print(f"- {name}: {text}")\nelse:\n    print("No test failures in summary.")' "$SUMMARY_JSON"
            fi
            if ! xcrun xcresulttool get object --legacy --path "$RESULT_BUNDLE" --format json > "$XCRESULT_JSON"; then
              echo "xcresulttool failed to read $RESULT_BUNDLE"
              xcrun xcresulttool get object --legacy --path "$RESULT_BUNDLE" --format json || true
            fi
          fi
          exit $RESULT

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            ${{ runner.temp }}/triangulum-tests.xcresult
            ${{ runner.temp }}/triangulum-tests.json
            ${{ runner.temp }}/triangulum-tests-summary.json
          if-no-files-found: warn
